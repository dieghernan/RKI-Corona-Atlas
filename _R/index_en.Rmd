---
title: "International COVID-19 risk areas"
subtitle: "as designated by the German government"
permalink: /en
header_type: hero
excerpt: |
  The interactive map allows you to explore
  Germany's current risk designation worldwide.
  Click in a specific country to read more details
  about that country and its regions
  regarding traveling to Germany.
always_allow_html: yes
output: 
  md_document:
    preserve_yaml: true
---


<!-- Modify _R/index_en.Rmd file instead -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```



```{r data_cleansing, echo=FALSE}

library(giscoR)
library(sf)
library(readr)
library(dplyr)
library(countrycode)
library(leaflet)
library(reactable)
library(rmarkdown)
library(leaflet.providers)
library(leaflet.extras)

data <- readr::read_csv("../assets/data/db_scraped.csv")
rl <- readr::read_csv("../assets/data/risk_level_code.csv")



data_cntries <-
  data %>% filter(ISO3_CODE != "ERROR" & is.na(ERROR)) %>%
  filter(is.na(region)) %>%
  left_join(rl) %>%
  select(ISO3_CODE, NAME_ENGL, REG_EXCLUDED, risk_date, risk_level_code, risk_level_en)

# EN - extract regions
regions <- data %>%
  filter(region == TRUE & risk_level_code != 5) %>%
  mutate(since = ifelse(is.na(risk_date),
                        "", paste0(", since ",
                       format(risk_date, "%d %b %Y")))) %>%
  group_by(ISO3_CODE) %>%
  mutate(regs = paste0("<li>", NAME_ENGL, since, "</li>", collapse = "")) %>%
  select(ISO3_CODE, regs) %>%
  distinct_all() %>%
  mutate(regs = paste0("<ul>", regs, "</ul>"))

# Add info

data_cntries <- data_cntries %>% left_join(regions)
data_cntries$more_info <- ifelse(is.na(data_cntries$risk_date),
                                 NA,
                                 paste0("Since ",
                                        format(data_cntries$risk_date, "%d %b %Y"),
                                        "."))

data_cntries$more_info <- ifelse(
  is.na(data_cntries$regs),
  data_cntries$more_info,
  ifelse(data_cntries$REG_EXCLUDED,
        paste0(
            data_cntries$more_info,
            " The following regions are excluded: ",
            data_cntries$regs),
        paste0(
            data_cntries$more_info,
            "The risk designation applies for the following regions: ",
            data_cntries$regs))
)

data_cntries$risk_date <-
  as.character(format(data_cntries$risk_date, format = "%d/%m/%Y"))

data_cntries$html_labels <- sprintf("<strong>%s</strong>",
                                    data_cntries$NAME_ENGL,
                                    data_cntries$risk_level_en)
data_cntries$html_labels <- ifelse(
  data_cntries$ISO3_CODE != "DEU",
  paste0(
    data_cntries$html_labels,
    "<br />",
    data_cntries$risk_level_en
  ),
  data_cntries$html_labels
)
#data_cntries$html_labels <- ifelse(!is.na(data_cntries$risk_date),
#                                   paste0(data_cntries$html_labels," seit ",data_cntries$risk_date),
#                                   data_cntries$html_labels
#                                   )

data_cntries$html_labels <- ifelse(
  !is.na(data_cntries$more_info),
  paste0(
    data_cntries$html_labels,
    "<p class='infomap'><strong>More information</strong><br />",
    data_cntries$more_info,
    "</p>"
  ),
  data_cntries$html_labels
)

data_cntries$html_labels <- data_cntries$html_labels %>% 
  lapply(htmltools::HTML)

date <- read.csv("../assets/data/report_date.csv") %>%
  select(report_date) %>% as.character() %>% 
  as.Date()


cntries_shape <-
  gisco_get_countries(
    year = 2020,
    epsg = 4326,
    cache_dir = "./geojson",
    resolution = 20
  )

# Add Kosovo
K <- st_read("./geojson/kosovo.geojson", quiet = TRUE) %>% select(ISO3_CODE)

cntries_shape_reg <-
  st_difference(cntries_shape, st_union(K))

cntries_shape_reg <- bind_rows(cntries_shape_reg, K)


cntries_shape_reg2 <- cntries_shape_reg %>%
  select(ISO3_CODE) %>%
  inner_join(data_cntries)

all_shapes <- st_make_valid(cntries_shape_reg2)

all_shapes <- all_shapes %>% select(ISO3_CODE) %>% left_join(data_cntries)

DEU <- all_shapes %>% filter(ISO3_CODE == "DEU")
level0 <- all_shapes %>% filter(risk_level_code == 0,
                                ISO3_CODE != "DEU")
level1 <- all_shapes %>% filter(risk_level_code == 1)
level2 <- all_shapes %>% filter(risk_level_code == 2)
level3 <- all_shapes %>% filter(risk_level_code == 3)
level4 <- all_shapes %>% filter(risk_level_code == 4)
```

<p class="text-right font-weight-bold">Updated on `r format(date, format="%d %B %Y")`</p>

## Risk map

The interactive map allows you to explore
Germany's current risk designation worldwide.
Click in a specific country to read more details
about that country and its regions
regarding traveling to Germany.




```{r map, echo=FALSE, out.width = "100%", out.height="75vh"}

labs <- rl$risk_level_en

labs <- labs[c(2:5, 1)]

map <- leaflet(options = leafletOptions(minZoom = 1),
  elementId = "leaflet") %>%
  setMaxBounds(-180,-90, 180, 90) %>%
  addProviderTiles("CartoDB.Voyager", group = "Carto Voyager") %>%
  addProviderTiles("Stamen.TerrainBackground", group = "Stamen Terrain") %>%
  addTiles(urlTemplate = "", 
           attribution = '&copy; <a href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units">EuroGeographics</a> for the administrative boundaries'
  ) %>%
  setView(lat = 51.705533, lng = 11.8124408, zoom = 4) %>%
  addPolygons(
    data = DEU,
    color = "#44444",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "blue",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = DEU$html_labels
  ) %>%
  addPolygons(
    data = level0,
    color = "#44444",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "#00FF00",
    fillOpacity = 0.5,
    group = labs[5],
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = level0$html_labels
  ) %>%
  addPolygons(
    data = level1,
    color = "#44444",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "red",
    fillOpacity = 0.5,
    group = labs[1],
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = level1$html_labels
  ) %>%
  addPolygons(
    data = level2,
    color = "#44444",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "chocolate",
    fillOpacity = 0.5,
    group = labs[2],
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = level2$html_labels
  ) %>%
  addPolygons(
    data = level3,
    color = "#44444",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "orange",
    fillOpacity = 0.5,
    group = labs[3],
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = level3$html_labels
  ) %>%
  addPolygons(
    data = level4,
    color = "white",
    weight = 0.5,
    smoothFactor = .1,
    opacity = 1,
    fillColor = "yellow",
    fillOpacity = 0.5,
    group = labs[4],
    highlightOptions = highlightOptions(
      color = "white",
      weight = 1,
      bringToFront = TRUE
    ),
    popup = level4$html_labels
  ) %>%
  addEasyButton(easyButton(
    icon = "fa-globe",
    title = "",
    onClick = JS(
      "function(btn, map){ map.setView([ 51.705533,11.8124408],4); }"
    )
  )) %>%
  addLayersControl(
    baseGroups = c("Carto Voyager", "Stamen Terrain"),
    overlayGroups = labs,
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
  addLegend(
    colors = c("red", "chocolate", "orange", "yellow", "#00FF00"),
    labels = labs,
    position = "bottomleft"
  ) %>%
  htmlwidgets::onRender(
    "
        function() {
            $('.leaflet-control-layers-overlays').prepend('<strong>Risk level</strong>');
        }
    "
  ) %>%
  addSearchOSM()
map


```

All information is directly fetched from the Robert Koch Institut and supplied without guarantee.
For a complete up-to-date overview on all international risk areas
visit [rki.de/risikogebiete](https://rki.de/risikogebiete).

The current travel restrictions for risk areas
are published on
[the website of the German Federal Ministry of Health](https://www.bundesgesundheitsministerium.de/en/coronavirus/current-information-for-travellers).

## Database

You can also browse the countries directly on the database.

<script src="https://cdn.jsdelivr.net/gh/dieghernan/RKI-Corona-Atlas/_R/plugins/reactable-binding-0.2.3/reactable.min.js"></script>
```{r table , echo=FALSE}


df <- st_drop_geometry(all_shapes)  %>%
  select(NAME_ENGL, risk_level_en, more_info)

names(df) <- c("Country/Region", "Risk level", "Details")

df <- df[order(df[, 1]), ]


readr::write_delim(df, "../assets/dist/db_countries_risk_en.csv",
                  delim = ";",
                  na = "")

# Strip HTML on Details
df$Details <- gsub("<\/li>", "; ", df$Details)
df$Details <- gsub("<.*?>", "", df$Details)
# df$Details <- gsub(",", ";", df$Details)

reactable(
  df,
  elementId = "reactable",
  filterable = TRUE,
  searchable = TRUE,
  showPageSizeOptions = TRUE,
  striped = TRUE,
  paginationType = "jump"
)

```

<p class="text-center my-5">
  <a href="assets/dist/db_countries_risk_en.csv" class="btn btn-primary">Download database (CSV)</a>
</p>
