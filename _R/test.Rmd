---
title: "Untitled"
subtitle: aaa
permalink: /test
always_allow_html: yes
output: 
  md_document:
    variant: gfm
    preserve_yaml: true
---


<!-- Modify _R/*.Rmd file instead -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```


## Including Code



```{r test, echo=FALSE}

library(giscoR)
library(sf)
library(readr)
library(dplyr)
library(countrycode)
library(leaflet)
library(reactable)
library(rmarkdown)
library(leaflet.providers)

data <- readr::read_csv("../assets/data/db_countries.csv")

cntries_shape <-
  gisco_get_countries(
    year = 2020,
    epsg = 4326,
    cache_dir = "../assets/data/geojson",
    resolution = 20
  )

# Get NUTS units
data_units <- data %>% filter(region == TRUE & !is.na(NUTS_CODE))


nuts_shape <- gisco_get_nuts(
  year = 2021,
  epsg = 4326,
  cache_dir = "../assets/data/geojson",
  resolution = 20,
  nuts_id = data_units$NUTS_CODE
)

# Get LAU
data_lau <- data_units %>% filter(!NUTS_CODE %in% nuts_shape$NUTS_ID)

lau_shape <- gisco_get_lau(
  year = 2019,
  epsg = 4326,
  cache_dir = "../assets/data/geojson",
  gisco_id = data_lau$NUTS_CODE
)


# Put all units together
nuts_shape_end <- nuts_shape %>%
  mutate(NUTS_CODE = NUTS_ID, name.en = NAME_LATN) %>%
  select(NUTS_CODE, name.en)

lau_shape_end <- lau_shape %>%
  mutate(NUTS_CODE = GISCO_ID, name.en = LAU_NAME, name.de = LAU_NAME) %>%
  select(NUTS_CODE, name.en)

regions_end <- bind_rows(nuts_shape_end, lau_shape_end) %>%
  inner_join(data) %>%
  select(NUTS_CODE, name.en, risk_level_code)


# Substract regions from countries

cntries_shape_reg <- st_difference(cntries_shape, st_union(regions_end))

data_cntries <- data %>% filter(is.na(region)) %>%
  select(ISO3_CODE, risk_level_code) %>% distinct()

cntries_shape_reg2 <- cntries_shape_reg %>%
  inner_join(data_cntries) %>%
  mutate(
    name.en = NAME_ENGL,
    name.de = countrycode(ISO3_CODE, "iso3c", "cldr.name.de")
  ) %>%
  select(ISO3_CODE, name.en, name.de, risk_level_code)

all_shapes <- bind_rows(cntries_shape_reg2, regions_end)
all_shapes <- st_make_valid(all_shapes)
#------


DEU <- all_shapes %>% filter(ISO3_CODE == "DEU")
level0 <- all_shapes %>% filter(risk_level_code == "0",
                                ISO3_CODE != "DEU" || !is.na(ISO3_CODE))
level1 <- all_shapes %>% filter(risk_level_code == "1")
level2 <- all_shapes %>% filter(risk_level_code == "2")
level3 <- all_shapes %>% filter(risk_level_code == "3")
level4 <- all_shapes %>% filter(risk_level_code == "4")

map <- leaflet(options = leafletOptions(minZoom = 0.5)) %>%
  setMaxBounds(-180, -90, 180, 90) %>%
  addProviderTiles("CartoDB.Voyager") %>%
  setView(lat = 51.705533, lng = 11.8124408, zoom = 4) %>%
  addPolygons(data = DEU, 
              stroke = FALSE,  
              fillColor = "blue",
              fillOpacity = 0.5) %>%
  addPolygons(data = level0,
              stroke = FALSE,
              fillColor = "green",
              fillOpacity = 0.5) %>%
  addPolygons(data = level1,
              stroke = FALSE,
              fillColor = "red",
              fillOpacity = 0.5) %>%
  addPolygons(data = level2,
              stroke = FALSE,
              fillColor = "orange",
              fillOpacity = 0.5) %>%
    addPolygons(data = level3,
              stroke = FALSE,
              fillColor = "yellow",
              fillOpacity = 0.5) %>%
    addPolygons(data = level4,
              stroke = FALSE,
              fillColor = "#00FF00",
              fillOpacity = 0.5) %>%
  addEasyButton(easyButton(
                           icon = "fa-globe",
                           title = "Zoom to Level 1",
                           onClick = JS(
                             "function(btn, map){ map.setView([ 51.705533,11.8124408],4); }"
                           )
                         ))


```


## This is the map
```{r map, echo=FALSE, out.width = "100%"}
map
```



## A Table

And this is the table

<script src="https://cdn.jsdelivr.net/gh/dieghernan/RKI-Corona-Atlas/_R/plugins/reactable-binding-0.2.3/reactable.min.js"></script>
```{r table , echo=FALSE}


df <- st_drop_geometry(all_shapes)

reactable(df,
          filterable = TRUE,
          searchable = TRUE,
          showPageSizeOptions = TRUE,
          striped = TRUE,
          paginationType = "jump"
          )

```

